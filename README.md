# Конвертер полей армирования Лира САПР → AutoCAD

LISP скрипт для преобразования 3D-граней из расчетного комплекса Лира САПР в удобные полилинии и штриховки для проверки армирования в AutoCAD.

## Назначение

Лира САПР выгружает поля армирования в формате DXF, где каждый элемент представлен как 3DFACE (трехмерная грань). Это неудобно для работы конструктора в AutoCAD.

Данный скрипт автоматически конвертирует все 3D-грани в:
- **Замкнутые полилинии** (контуры элементов)
- **Штриховки с прозрачностью** (заливка для наглядности)

Готовую подложку можно положить под чертеж и проверить армирование.

---

## Установка и запуск

### 1. Открыть файл из Лира САПР

В AutoCAD:
```
Меню: File → Open
Выберите файл: Парковка_низ_Х.dxf
```

### 2. Загрузить скрипт

```
Команда: APPLOAD
```

В открывшемся диалоге выберите файл `3dface-to-hatch.lsp` и нажмите "Загрузить".

### 3. Запустить команду

После загрузки доступны три команды:

#### **LIRA2HATCH** - Полная версия с настройками

```
Команда: LIRA2HATCH
```

**Интерактивные опции:**
1. Удалить оригинальные 3DFACE? [Да/Нет] → рекомендуется **Да**
2. Создать [Контуры/Штриховки] → выберите **Штриховки**
3. Прозрачность штриховки (0-90) → рекомендуется **70**

Скрипт автоматически обработает все объекты в файле.

#### **3DFACE2HATCH** - Быстрая версия

```
Команда: 3DFACE2HATCH
```

Автоматически создает полилинии + штриховки с прозрачностью 70%.
Без вопросов, быстрая обработка.

#### **3DFACE2PLINE** - Только контуры

```
Команда: 3DFACE2PLINE
```

Создает только замкнутые полилинии без штриховок.
Подходит для случаев, когда нужны только контуры.

---

## Что делает скрипт

### Входные данные
- **Формат:** DXF файл с объектами типа 3DFACE
- **Источник:** Лира САПР (поля армирования)
- **Координаты:** 3D точки (X, Y, Z)

### Процесс обработки

1. **Поиск всех 3DFACE** объектов в чертеже
2. **Извлечение координат** вершин (используется проекция на плоскость XY)
3. **Создание полилиний:**
   - Замкнутые LWPOLYLINE
   - Имя слоя: `<оригинальный_слой>_contour`
   - Сохраняются цвета из Лира САПР
4. **Создание штриховок:**
   - Сплошная заливка (SOLID)
   - Имя слоя: `<оригинальный_слой>_hatch`
   - Настраиваемая прозрачность (по умолчанию 70%)
   - Сохраняются цвета из Лира САПР

### Выходные данные

- **Полилинии** на слое `layer_elements_contour`
- **Штриховки** на слое `layer_elements_hatch`
- Оригинальные 3DFACE удаляются (опционально)

---

## Примеры использования

### Пример 1: Стандартная подложка для проверки

```
1. Открыть DXF из Лира
2. Команда: LIRA2HATCH
3. Удалить оригинальные? → Да
4. Создать → Штриховки
5. Прозрачность → 70
6. Готово!
```

**Результат:** Чистый чертеж с контурами и полупрозрачными штриховками, готовый для использования как подложка.

### Пример 2: Быстрая обработка большого файла

```
1. Открыть DXF из Лира
2. Команда: 3DFACE2HATCH
3. Дождаться завершения
```

**Результат:** Автоматическая обработка без вопросов, подходит для больших файлов.

### Пример 3: Только контуры для печати

```
1. Открыть DXF из Лира
2. Команда: 3DFACE2PLINE
```

**Результат:** Только полилинии без штриховок, удобно для печати или экспорта.

---

## Технические детали

### Совместимость

- **AutoCAD:** версии 2007 и выше
- **Язык:** Русская и английская версии AutoCAD
- **Платформа:** Windows, Mac, Linux (через AutoCAD)

### Как работает внутри

Скрипт написан на AutoLISP и использует:

1. **`entget`** - чтение данных объектов
2. **`entmake`** - создание полилиний напрямую (без команд)
3. **`command`** - вызов команды BHATCH для штриховок
4. **`entmod`** - изменение свойств объектов

**Функция `get-xy`:**
```lisp
(defun get-xy (coord-code entdata coord-y-code)
  ;; Извлекает X и Y из 3DFACE координат
  ;; Поддерживает формат (X Y Z) из Лира САПР
)
```

**Функция `make-lwpolyline`:**
```lisp
(defun make-lwpolyline (ptlist layer color)
  ;; Создает замкнутую полилинию через entmake
  ;; Работает без команд - универсально
)
```

### Структура слоев

```
Оригинал: layer_elements
    ↓
Результат:
    - layer_elements_contour (полилинии)
    - layer_elements_hatch (штриховки)
```

### Обработка цветов

Скрипт поддерживает:
- **ACI цвета** (1-255)
- **TrueColor** (RGB)
- Автоматически определяет тип цвета из файла Лира

---

## Производительность

| Количество 3DFACE | Время обработки | Рекомендуемая команда |
|-------------------|-----------------|----------------------|
| < 1000            | < 10 сек        | LIRA2HATCH          |
| 1000 - 5000       | 10-60 сек       | 3DFACE2HATCH        |
| > 5000            | 1-5 мин         | 3DFACE2PLINE (сначала) |

**Прогресс:** Скрипт показывает счетчик обработанных объектов каждые 50-100 элементов.

---

## Устранение неполадок

### Проблема: "Не найдено объектов 3DFACE"

**Решение:** Убедитесь, что в файле есть объекты типа 3DFACE:
```
Команда: QSELECT
Тип объекта: 3DFACE
```

### Проблема: "Ошибка: неверная DXF-группа"

**Решение:** Файл поврежден или имеет нестандартный формат. Попробуйте:
1. Пересохранить DXF из Лира САПР
2. Проверить версию AutoCAD (должна быть 2007+)

### Проблема: Штриховки не видны

**Решение:**
1. Проверьте слой `*_hatch` - он должен быть включен
2. Увеличьте прозрачность: запустите LIRA2HATCH с параметром 50-60

### Проблема: Слишком долго обрабатывается

**Решение:**
1. Используйте команду 3DFACE2PLINE для первого прохода
2. Отключите удаление оригиналов (выберите "Нет")
3. Закройте ненужные приложения

---

## Советы по работе

### 1. Проверка перед обработкой

Перед запуском скрипта рекомендуется:
- Сохранить резервную копию DXF файла
- Проверить количество 3DFACE: `QSELECT → 3DFACE`
- Закрыть другие чертежи в AutoCAD

### 2. Настройка слоев после обработки

После обработки удобно:
- Установить разные цвета для `*_contour` и `*_hatch`
- Настроить толщину линий контуров (0.25-0.35 мм)
- Заморозить слой `*_hatch` для печати

### 3. Использование как подложка

Для использования результата как подложки:
```
1. Выделить все созданные объекты
2. Команда: WBLOCK → сохранить в отдельный файл
3. В рабочем чертеже: XREF → прикрепить подложку
4. Настроить прозрачность XREF при необходимости
```

---

## Автор и лицензия

Скрипт создан для автоматизации работы конструкторов, работающих с Лира САПР и AutoCAD.

**Версия:** 3.0
**Дата:** 2025-11-15
**Лицензия:** Свободное использование

---

## Версии скрипта

### v3.0 (текущая)
- ✅ Универсальная поддержка русской/английской версий AutoCAD
- ✅ Создание полилиний через `entmake` (без команд)
- ✅ Поддержка TrueColor и ACI цветов
- ✅ Настраиваемая прозрачность штриховок
- ✅ Три режима работы (LIRA2HATCH, 3DFACE2HATCH, 3DFACE2PLINE)

### v2.0
- Прямая установка свойств через `entmod`
- Отключение CMDECHO для тихой работы

### v1.0
- Базовая функциональность конвертации 3DFACE

---

## Контакты и поддержка

Если у вас возникли вопросы или предложения по улучшению скрипта, создайте issue в репозитории проекта.

**Полезные ссылки:**
- [Документация AutoLISP](https://help.autodesk.com/view/OARX/2024/ENU/)
- [Форум Лира САПР](https://www.liraland.com/)

---

## Дополнительные возможности

Скрипт можно доработать под специфические задачи:

- Фильтрация по диапазону значений армирования
- Создание легенды с градацией цветов
- Экспорт в другие форматы (PDF, PNG)
- Автоматическая подпись элементов

Для доработки обратитесь к специалисту по AutoLISP.
